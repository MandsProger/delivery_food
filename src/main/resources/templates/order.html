<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Ваш заказ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=b4892dee-bb9b-4b60-acbb-31b2f3f8dae6"></script>
    <style>
        #map {
            height: 400px; /* Высота карты */
            width: 100%;   /* Ширина карты */
            border-radius: 10px; /* Скругление углов */
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Тень для карты */
        }
        .address {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 10px;
            background-color: #fff;
        }
    </style>
</head>
<body>
<header th:insert="~{blocks/header :: header}"></header>
<main>
    <div class="container mt-5 d-flex">
        <div class="address" style="width: 600px; margin-right: 20px;">
            <h4>Адрес доставки</h4><br>
            <div id="map"></div>
            <div class="form-row mb-4">
                <input type="text" name="street" placeholder="Улица" class="form-control mb-1" style="width: 250px;" required>
                <input type="text" name="house" placeholder="Дом" class="form-control" style="width: 100px;" required>
            </div>
            <div class="form-row mb-2 d-flex">
                <input type="text" name="apartment" placeholder="кв./дом" class="form-control" required>
                <input type="text" name="intercom" placeholder="домофон" class="form-control">
                <input type="text" name="porch" placeholder="подъезд" class="form-control">
                <input type="text" name="floor" placeholder="этаж" class="form-control" required>
            </div>
            <div class="form-row mb-4">
                <input type="text" name="comment" placeholder="Комментарий к заказу" class="form-control">
            </div>
            <h4>Время доставки</h4>
            <h5>Доставка + TIME</h5>
        </div>

        <div class="contentOrder" style="width: 600px; margin-top: 850px; margin-left: -620px;">
            <h4>Ваш заказ</h4><br>
            <ul class="list-group">
                <li th:each="item : ${cartItems}" class="list-group-item">
                    <h4 th:text="${item.foodName}"></h4>
                    <h5 th:text="${item.count} + ' шт.'"></h5>
                    <h4 th:text="${item.price} + ' руб.'"></h4>
                    <form th:action="'/order/' + ${item.id} + '/remove'" method="post">
                        <button class="btn btn-warning" type="submit">Удалить</button>
                    </form>
                </li>
            </ul>
        </div>

        <div class="payment" style="width: 400px; position: fixed; margin-top: 220px; margin-left: 800px;">
            <form id="paymentForm" method="post" action="/order/pay" style="flex-grow: 1;">
                <h4>Способ оплаты</h4>
                <select name="paymentMethod" class="mt-3 form-select">
                    <option value="CARD">Картой курьеру</option>
                    <option value="CASH">Наличные</option>
                </select><br>
                <h4>Цена</h4>
                <h5 style="display: flex; justify-content: space-between;">
                    <span th:text="'Товары в заказе'"></span>
                    <span th:text="${sum} + ' руб.'"></span>
                </h5>
                <h5 style="display: flex; justify-content: space-between;">
                    <span th:text="'Доставка'"></span>
                    <span th:text="'149.0 руб.'"></span>
                </h5>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <input type="hidden" name="_csrf" value="${_csrf.token}">
                    <button type="submit" class="btn btn-success mt-3" style="width: 65%;">Оплатить</button>
                    <input type="hidden" name="resultPrice" th:value="${sum + 149}">
                    <input type="hidden" name="userId" th:value="${user.getNumberPhone()}">
                    <input type="hidden" name="costDelivery" th:value="149">
                    <h5 style="margin-top: 20px;" name="feedback" th:text="${sum + 149} + ' руб.'"></h5>
                </div>
            </form>
        </div>
    </div>
</main>
<div th:insert="~{blocks/footer :: footer}"></div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        let map, marker;

        // Инициализация карты и маркера
        ymaps.ready(() => {
            map = new ymaps.Map("map", {
                center: [55.751244, 37.618423], // Начальные координаты (Москва)
                zoom: 12,
                controls: ['smallMapDefaultSet'],
                behaviors: ['default', 'scrollZoom']
            });

            marker = new ymaps.Placemark(map.getCenter(), {
                hintContent: 'Выберите адрес',
                balloonContent: 'Вы здесь'
            }, {
                preset: 'islands#icon',
                iconColor: '#0095b6'
            });

            map.geoObjects.add(marker);

            map.events.add('click', e => {
                const coords = e.get('coords');
                marker.geometry.coordinates = coords;
                getAddress(coords);
            });
        });

        function getAddress(coords) {
            ymaps.geocode(coords).then(res => {
                const address = res.geoObjects.get(0).properties.get('name');
                fillAddressFields(address.split(', '));
            }).catch(err => alert("Не удалось получить адрес: " + err));
        }

        function fillAddressFields(components) {
            const [street, house] = components;
            document.querySelector("input[name='street']").value = street || '';
            document.querySelector("input[name='house']").value = house || '';
        }

        // Обработка отправки формы
        document.querySelector("#paymentForm").addEventListener("submit", event => {
            const street = document.querySelector("input[name='street']").value;
            const house = document.querySelector("input[name='house']").value;
            const apartment = document.querySelector("input[name='apartment']").value;
            const floor = document.querySelector("input[name='floor']").value;

            // Проверка на заполненность обязательных полей
            if (!street || !house || !apartment || !floor) {
                event.preventDefault(); // Остановить отправку формы
                alert("Пожалуйста, заполните обязательные поля адреса: Улица, Дом, Квартира и Этаж."); // Уведомление для пользователя
                return; // Выход из функции
            }

            const addressFields = ["street", "house", "apartment", "intercom", "porch", "floor"];
            addressFields.forEach(field => {
                let value = document.querySelector(`input[name='${field}']`).value;
                let hiddenField = document.createElement("input");
                hiddenField.type = "hidden";
                hiddenField.name = field;
                hiddenField.value = value;
                paymentForm.appendChild(hiddenField); // Добавление скрытых полей в форму
            });
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
</body>
</html>